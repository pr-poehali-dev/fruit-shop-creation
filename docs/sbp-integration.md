# Подключение СБП (Система Быстрых Платежей) через Сбербанк

## Шаг 1: Регистрация в Сбербанк Бизнес

### Для самозанятых и ИП:
1. Откройте расчётный счёт в Сбербанке (если ещё нет)
2. Зарегистрируйтесь в **Сбербанк Бизнес Онлайн**: https://business.sber.ru/
3. Войдите в личный кабинет

### Документы для регистрации:
- Паспорт
- ИНН (для самозанятых — из приложения "Мой налог")
- СНИЛС
- Реквизиты расчётного счёта

---

## Шаг 2: Подключение "Приём платежей по СБП"

1. В **Сбербанк Бизнес Онлайн** → Меню → **"Эквайринг"**
2. Выберите **"Приём платежей по СБП"**
3. Заполните заявку:
   - Наименование организации/ИП
   - Вид деятельности (интернет-магазин)
   - URL сайта
   - Ожидаемый оборот в месяц
4. Согласитесь с условиями (комиссия 0.4-0.7%)
5. Отправьте заявку

**Время рассмотрения:** 1-3 рабочих дня

---

## Шаг 3: Получение API ключей

После одобрения заявки:

1. В личном кабинете → **"API и интеграции"** → **"СБП API"**
2. Создайте API-ключ
3. Сохраните следующие данные:
   - `SBERBANK_MERCHANT_ID` — ID мерчанта
   - `SBERBANK_API_KEY` — API ключ для запросов
   - `SBERBANK_SECRET_KEY` — Секретный ключ для проверки подписи

**⚠️ ВАЖНО:** Сохраните ключи в надёжном месте — они показываются только один раз!

---

## Шаг 4: Добавление секретов в проект

1. В редакторе poehali.dev откройте чат с Юрой
2. Напишите: **"Добавь секреты для СБП"**
3. Юра создаст 3 секрета:
   - `SBERBANK_MERCHANT_ID`
   - `SBERBANK_API_KEY`
   - `SBERBANK_SECRET_KEY`
4. Нажмите на каждый секрет и вставьте значения из Сбербанк Бизнес

---

## Шаг 5: Настройка Webhook (уведомления о платежах)

### В Сбербанк Бизнес:
1. Перейдите в **"API и интеграции"** → **"Webhook"**
2. Добавьте URL для уведомлений:
   ```
   https://functions.poehali.dev/[ваш-id-функции]/webhook
   ```
3. Выберите события:
   - ✅ `payment.succeeded` — успешная оплата
   - ✅ `payment.canceled` — отмена платежа

### Получение ID функции:
1. В редакторе poehali.dev откройте файл `backend/func2url.json`
2. Найдите строку с `"sbp-payment"`: `"https://functions.poehali.dev/[id]"`
3. Скопируйте ID из URL

**Пример webhook URL:**
```
https://functions.poehali.dev/eb724c49-3637-42d6-aba0-7fc3565d9c2b/webhook
```

---

## Шаг 6: Тестирование

### Тестовая среда Сбербанка:
1. В личном кабинете включите **"Тестовый режим"**
2. Используйте тестовый API ключ
3. Создайте тестовый платёж на сайте (минимум 10₽)
4. Откроется форма СБП → выберите **"Тестовый банк"**
5. Подтвердите оплату
6. Проверьте, что баланс пополнился

### Проверка в продакшене:
1. Отключите тестовый режим
2. Используйте боевые API ключи
3. Создайте реальный платёж (минимум 10₽)
4. Оплатите через своё банковское приложение
5. Убедитесь, что баланс пополнился

---

## Как работает СБП для клиентов

### Процесс оплаты:
1. Клиент на сайте нажимает **"Пополнить баланс"**
2. Вводит сумму (минимум 10₽)
3. Нажимает **"Оплатить через СБП"**
4. Открывается QR-код или ссылка для оплаты
5. Клиент сканирует QR или открывает ссылку
6. Выбирает свой банк (Сбербанк, Тинькофф, Альфа и т.д.)
7. Подтверждает платёж в приложении банка
8. **Деньги моментально приходят на ваш счёт**
9. Сервер получает уведомление → баланс клиента пополняется

### Преимущества для клиентов:
- ✅ Не нужна карта — только телефон
- ✅ Работает со всеми банками России
- ✅ Мгновенное зачисление 24/7
- ✅ Безопасно — без ввода данных карты
- ✅ Самая низкая комиссия

---

## Комиссия СБП

| Оборот в месяц | Комиссия Сбербанка |
|----------------|-------------------|
| До 100 000₽   | 0.7%              |
| 100 000 - 500 000₽ | 0.5%       |
| Свыше 500 000₽ | 0.4%             |

**Для клиента:** комиссия 0% (платит магазин)

---

## Техническая документация

### API для создания платежа:
```
POST https://api.sberbank.ru/sbp/v2/payments
Headers:
  Authorization: Bearer {API_KEY}
  X-Merchant-Id: {MERCHANT_ID}
Body:
{
  "amount": 100.00,
  "currency": "RUB",
  "description": "Пополнение баланса",
  "order_id": "user_123_1234567890",
  "return_url": "https://ваш-сайт.ru/payment-success"
}
```

### Ответ:
```json
{
  "payment_id": "abc123",
  "payment_url": "https://qr.nspk.ru/...",
  "qr_code": "data:image/png;base64,..."
}
```

### Webhook (уведомление о платеже):
```json
{
  "event": "payment.succeeded",
  "payment_id": "abc123",
  "order_id": "user_123_1234567890",
  "amount": 100.00,
  "currency": "RUB",
  "created_at": "2024-10-14T12:00:00Z",
  "signature": "sha256_hash"
}
```

---

## Что делать после получения ключей

Напишите Юре:
```
Юра, обнови функцию sbp-payment:
- MERCHANT_ID: [твой ID]
- API_KEY: [твой ключ]
- Добавь создание платежа через API Сбербанка
- Добавь webhook для обработки уведомлений
```

Юра автоматически:
1. Обновит backend функцию с реальной интеграцией
2. Добавит обработку webhook
3. Настроит автоматическое пополнение баланса
4. Протестирует интеграцию

---

## Частые вопросы

**В: Можно ли использовать СБП без расчётного счёта?**
О: Нет, для приёма платежей нужен расчётный счёт ИП или самозанятого.

**В: Сколько времени зачисляются деньги?**
О: Моментально. Клиент оплатил → деньги сразу на вашем счету.

**В: Можно ли вернуть деньги клиенту?**
О: Да, через личный кабинет Сбербанк Бизнес или API.

**В: Работает ли СБП с иностранными картами?**
О: Нет, только российские банки.

**В: Нужен ли SSL сертификат на сайте?**
О: Да, обязательно (HTTPS). В poehali.dev SSL включён автоматически.

---

## Поддержка

**Сбербанк Бизнес:**
- Телефон: 8 800 555 55 50
- Чат в приложении Сбербанк Бизнес

**Техподдержка poehali.dev:**
- Telegram: https://t.me/+QgiLIa1gFRY4Y2Iy
- Напишите Юре в чате редактора
